{% load static %}
<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MIO - Profilo</title>
    <link rel="stylesheet/less" href="{% static 'core/styles.less' %}?v=retro1">
    {% include "core/partials/uikit_head.html" %}
    <script src="{% static 'core/vendor/less/less.min.js' %}"></script>
  </head>
  <body>
    <div class="shell">
      <header class="shell-header">
        <div class="brand">
          <div class="brand-mark">MIO</div>
          <div class="brand-text">
            <div class="brand-title">Money Organizer</div>
            <div class="brand-sub">Impostazioni utente</div>
          </div>
        </div>
        <nav class="shell-nav">
          <a href="/">Dashboard</a>
          <a href="/accounts/logout/">Logout</a>
        </nav>
      </header>

      {% block content %}
        <section class="panel profile-panel">
          <h1>Profilo</h1>
          <p class="muted">Gestisci le informazioni personali e le preferenze.</p>

          {% if messages %}
            <div class="profile-flash-stack">
              {% for message in messages %}
                <div class="profile-flash">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}

          <div class="profile-grid">
            <div class="profile-card">
              <h2>Dati principali</h2>
              <div class="profile-row">
                <span class="label">Username</span>
                <span>{{ request.user.username }}</span>
              </div>
              <div class="profile-row">
                <span class="label">Email</span>
                <span>{{ request.user.email|default:"-" }}</span>
              </div>
              <div class="profile-row">
                <span class="label">Ultimo login</span>
                <span>{{ request.user.last_login|default:"-" }}</span>
              </div>
              <div class="profile-row">
                <span class="label">Accounts</span>
                <a class="link" href="/core/accounts/">Gestisci</a>
              </div>
            </div>

            <div class="profile-card">
              <h2>Preferenze</h2>
              <div class="profile-row">
                <span class="label">Hero actions</span>
                <a class="link" href="/profile/hero-actions/">Configura</a>
              </div>
              <form class="form" method="post" action="">
                {% csrf_token %}
                <div class="field">
                  <label for="timezone">Timezone</label>
                  <select id="timezone" name="timezone">
                    <option>UTC</option>
                    <option>Europe/Rome</option>
                    <option>Europe/Milan</option>
                  </select>
                </div>
                <div class="field">
                  <label for="currency">Valuta default</label>
                  <select id="currency" name="currency">
                    <option>EUR</option>
                    <option>USD</option>
                    <option>GBP</option>
                  </select>
                </div>
                <div class="actions">
                  <button class="btn primary" type="submit">Salva</button>
                </div>
              </form>
            </div>

            <div class="profile-card profile-card-wide" id="archibald-instructions">
              <h2>Istruzioni Attive Archibald</h2>
              <p class="muted">
                Personalizza lo stile operativo del maggiordomo e salva stati richiamabili per diversi contesti.
              </p>
              <form class="form archibald-instructions-form" method="post" action="">
                {% csrf_token %}
                <div class="field">
                  <label for="archibald_custom_instructions">Istruzioni personalizzate</label>
                  <textarea
                    id="archibald_custom_instructions"
                    name="archibald_custom_instructions"
                    rows="8"
                    placeholder="Es: evita toni troppo accondiscendenti, vai diretto su analisi + piano, evidenzia tradeoff."
                  >{{ archibald_custom_instructions }}</textarea>
                </div>
                <div class="archibald-tools-row">
                  <button class="btn primary" type="submit" name="action" value="save_archibald_instructions">
                    Salva istruzioni attive
                  </button>
                  <input
                    type="text"
                    class="archibald-state-name"
                    name="state_name"
                    maxlength="120"
                    placeholder="Nome stato (es. Operativo Secco)"
                  >
                  <button class="btn" type="submit" name="action" value="save_archibald_state">
                    Salva come stato
                  </button>
                </div>
              </form>

              <details class="archibald-system-preview">
                <summary>Istruzioni complete attive (preview)</summary>
                <pre>{{ archibald_system_preview }}</pre>
              </details>

              <div class="archibald-states-section">
                <h3>Stati salvati</h3>
                {% if archibald_instruction_states %}
                  <div class="archibald-states-grid">
                    {% for state in archibald_instruction_states %}
                      <article class="archibald-state-card">
                        <div class="archibald-state-name-label">{{ state.name }}</div>
                        <div class="archibald-state-meta">Aggiornato: {{ state.updated_at|date:"d/m/Y H:i" }}</div>
                        <pre class="archibald-state-snippet">{{ state.instructions_text|default:"(vuoto)" }}</pre>
                        <div class="actions">
                          <form method="post" action="">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="apply_archibald_state">
                            <input type="hidden" name="state_id" value="{{ state.id }}">
                            <button class="btn" type="submit">Applica</button>
                          </form>
                          <form method="post" action="">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_archibald_state">
                            <input type="hidden" name="state_id" value="{{ state.id }}">
                            <button class="btn danger" type="submit">Elimina</button>
                          </form>
                        </div>
                      </article>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="note">Nessuno stato salvato al momento.</div>
                {% endif %}
              </div>
            </div>

            <div class="profile-card profile-card-wide" id="bias-cognitivi">
              <h2>Bias Cognitivi</h2>
              <p class="muted">
                Sezione dedicata: scegli i bias che Archibald deve monitorare quando il controllo bias Ã¨ attivo.
              </p>
              <form class="form bias-settings-form" method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="action" value="save_bias_settings">
                <div class="bias-grid">
                  <label class="bias-item">
                    <input type="checkbox" name="bias_catastrophizing" {% if archibald_persona.bias_catastrophizing %}checked{% endif %}>
                    <span>Catastrofismo</span>
                  </label>
                  <label class="bias-item">
                    <input type="checkbox" name="bias_all_or_nothing" {% if archibald_persona.bias_all_or_nothing %}checked{% endif %}>
                    <span>Pensiero tutto-o-nulla</span>
                  </label>
                  <label class="bias-item">
                    <input type="checkbox" name="bias_overgeneralization" {% if archibald_persona.bias_overgeneralization %}checked{% endif %}>
                    <span>Sovrageneralizzazione</span>
                  </label>
                  <label class="bias-item">
                    <input type="checkbox" name="bias_mind_reading" {% if archibald_persona.bias_mind_reading %}checked{% endif %}>
                    <span>Lettura del pensiero</span>
                  </label>
                  <label class="bias-item">
                    <input type="checkbox" name="bias_negative_filtering" {% if archibald_persona.bias_negative_filtering %}checked{% endif %}>
                    <span>Filtro negativo</span>
                  </label>
                  <label class="bias-item">
                    <input type="checkbox" name="bias_confirmation_bias" {% if archibald_persona.bias_confirmation_bias %}checked{% endif %}>
                    <span>Bias di conferma</span>
                  </label>
                </div>
                <div class="actions">
                  <button class="btn primary" type="submit">Salva bias cognitivi</button>
                </div>
              </form>
            </div>

            <div class="profile-card">
              <h2>Sicurezza</h2>
              <div class="profile-row">
                <span class="label">Cambio password</span>
                <a class="link" href="/accounts/password_change/">Vai</a>
              </div>
              <div class="profile-row">
                <span class="label">Logout</span>
                <a class="link" href="/accounts/logout/">Esci</a>
              </div>
            </div>
          </div>
        </section>
      {% endblock %}
    </div>
      {% include "core/partials/uikit_body.html" %}
  </body>
</html>
