{% extends "transactions/base.html" %}

{% block title %}MIO - Transactions{% endblock %}

{% block content %}
  <section class="hero" id="app-head">
    <div class="hero-copy" id="app-header">
      <h1>Transazioni</h1>
      <p>Vista unificata per entrate, uscite e trasferimenti.</p>
    </div>
    <div class="hero-card" id="transactions-upcoming-panel">
      <div class="card-title" id="upcoming-title">Totali per tipo</div>
      <ul class="list" id="transactions-upcoming-list">
        <li><span class="dot dot-green"></span><span>Entrate</span><span class="muted">{{ totals.IN|default:0 }}</span></li>
        <li><span class="dot dot-red"></span><span>Uscite</span><span class="muted">{{ totals.OUT|default:0 }}</span></li>
        <li><span class="dot dot-amber"></span><span>Trasferimenti</span><span class="muted">{{ totals.XFER|default:0 }}</span></li>
      </ul>
    </div>
  </section>

  <section class="panel" id="transactions-filters-panel">
    <h2 id="transactions-filters-title">Filtri</h2>
    <form class="form filter-form" method="get" action="" id="transactions-filters-form">
      <div class="field">
        <label for="type">Tipo</label>
        <select id="type" name="type">
          <option value="">Tutti</option>
          <option value="IN" {% if filters.type == "IN" %}selected{% endif %}>Entrate</option>
          <option value="OUT" {% if filters.type == "OUT" %}selected{% endif %}>Uscite</option>
          <option value="XFER" {% if filters.type == "XFER" %}selected{% endif %}>Trasferimenti</option>
        </select>
      </div>
      <div class="field">
        <label for="from">Dal</label>
        <input id="from" name="from" type="text" class="date-field" value="{{ filters.from }}">
      </div>
      <div class="field">
        <label for="to">Al</label>
        <input id="to" name="to" type="text" class="date-field" value="{{ filters.to }}">
      </div>
      <div class="actions">
        <button class="btn primary" type="submit">Applica</button>
        <a class="btn" href="/transactions/">Reset</a>
      </div>
    </form>
  </section>

  <section class="panel" id="transactions-list-panel">
    <h2 id="transactions-list-title">Ultime transazioni</h2>
    <div class="transactions-grid-shell">
      <div id="transactions-grid" class="transactions-grid"></div>
      <div id="transactions-grid-fallback" class="note" hidden>
        Impossibile caricare la grid. Ricarica la pagina.
      </div>
    </div>
  </section>
  {{ grid_rows|json_script:"transactions-grid-data" }}
  <script>
    (function () {
      function initGrid() {
        var payload = document.getElementById("transactions-grid-data");
        var fallback = document.getElementById("transactions-grid-fallback");
        var gridTarget = document.getElementById("transactions-grid");
        if (!payload || !gridTarget) {
          if (fallback) {
            fallback.hidden = false;
          }
          return;
        }

        var rows = JSON.parse(payload.textContent || "[]");
        var makeTypeChip = function (row) {
          if (row.type_code === "IN") {
            return '<span class="tx-type-chip tx-type-chip--in">Entrata</span>';
          }
          if (row.type_code === "OUT") {
            return '<span class="tx-type-chip tx-type-chip--out">Uscita</span>';
          }
          return '<span class="tx-type-chip tx-type-chip--xfer">Trasferimento</span>';
        };
        var actionButton = function (label, href, className) {
          var css = "tx-action " + (className || "");
          if (!href) {
            return '<span class="' + css + ' is-muted">' + label + "</span>";
          }
          return '<a class="' + css + '" href="' + href + '">' + label + "</a>";
        };
        var actionCell = function (row) {
          return [
            '<div class="tx-actions">',
            actionButton("Modifica", row.update_url, "is-primary"),
            actionButton("Rimuovi", row.remove_url, "is-danger"),
            actionButton("Allegato", row.attachment_url, ""),
            actionButton("Tipo", row.filter_type_url, ""),
            "</div>",
          ].join("");
        };

        new window.tui.Grid({
          el: gridTarget,
          data: rows,
          scrollX: true,
          scrollY: true,
          bodyHeight: 420,
          rowHeight: 46,
          minRowHeight: 44,
          columnOptions: { resizable: true },
          columns: [
            { header: "Data", name: "date", align: "center", width: 110, sortable: true },
            {
              header: "Tipo",
              name: "type_code",
              align: "center",
              width: 140,
              sortable: true,
              formatter: function (ctx) {
                return makeTypeChip(ctx.row);
              },
              escapeHTML: false,
            },
            { header: "Controparte", name: "counterparty", minWidth: 180, sortable: true },
            { header: "Nota", name: "note", minWidth: 220 },
            {
              header: "Importo",
              name: "amount",
              align: "right",
              width: 140,
              sortable: true,
              formatter: function (ctx) {
                return ctx.row.amount + " " + ctx.row.currency;
              },
            },
            { header: "Account", name: "account", minWidth: 180, sortable: true },
            { header: "Progetto", name: "project", minWidth: 140, sortable: true },
            { header: "Categoria", name: "category", minWidth: 130, sortable: true },
            {
              header: "Azioni rapide",
              name: "actions",
              align: "right",
              minWidth: 280,
              formatter: function (ctx) {
                return actionCell(ctx.row);
              },
              escapeHTML: false,
            },
          ],
        });
      }

      function waitForGrid(maxAttempts) {
        var fallback = document.getElementById("transactions-grid-fallback");
        if (window.tui && window.tui.Grid) {
          initGrid();
          return;
        }
        if (maxAttempts <= 0) {
          if (fallback) {
            fallback.hidden = false;
          }
          return;
        }
        window.setTimeout(function () {
          waitForGrid(maxAttempts - 1);
        }, 120);
      }

      if (document.readyState === "complete") {
        waitForGrid(25);
      } else {
        window.addEventListener("load", function () {
          waitForGrid(25);
        });
      }
    })();
  </script>
{% endblock %}
